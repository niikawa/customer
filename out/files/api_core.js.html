<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>api/core.js</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
	    <img alt="" src="../assets/css/logo.png" style="max-height: 65%;" title="">
            
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b></b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/api.Approach", "classes/api.Auth", "classes/api.core", "classes/api.Environment", "classes/api.log", "classes/api.Query", "classes/api.QueryDOc", "classes/api.Table"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
	        <h3>APIs</h3>
	        <div id="sidebar">
	            <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
	                <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
	                <li><a href="#modules" data-toggle="tab">Modules</a></li>
	            </ul>
	    
	            <div id="api-tabview-filter">
	                <input type="search" placeholder="Type to filter APIs">
	            </div>
	    
	            <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
	                <div class="tab-pane active" id="classes">
	                    <ul id="api-classes" class="nav nav-list">
	                            <li><a href="../classes/api.Approach.html">api.Approach</a></li>
	                            <li><a href="../classes/api.Auth.html">api.Auth</a></li>
	                            <li><a href="../classes/api.core.html">api.core</a></li>
	                            <li><a href="../classes/api.Environment.html">api.Environment</a></li>
	                            <li><a href="../classes/api.log.html">api.log</a></li>
	                            <li><a href="../classes/api.Query.html">api.Query</a></li>
	                            <li><a href="../classes/api.QueryDOc.html">api.QueryDOc</a></li>
	                            <li><a href="../classes/api.Table.html">api.Table</a></li>
	                    </ul>
	                </div>
	    
	                <div class="tab-pane" id="modules">
	                    <ul id="api-modules" class="nav nav-list">
	                    </ul>
	                </div>
	            </div>
	        </div>
	    </div>
        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
                    Show:
                    <label for="api-show-inherited" class="checkbox">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected" class="checkbox">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private" class="checkbox">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated" class="checkbox">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </form>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>api/core.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
var moment = require(&#x27;moment&#x27;);
var logInfo = require(&#x27;../config/controlLog&#x27;);

/**
 * core class
 * 
 * @namespace api
 * @class core
 * @constructor
 */
var core = function core(modelName, pk, seqName)
{
    this.modelName = modelName;
    this.pk = pk;
    this.seqName = seqName;
};

core.prototype.getPk = function()
{
    return this.pk;
};

core.prototype.momoent = require(&#x27;moment&#x27;);

core.prototype.async = require(&#x27;async&#x27;);

core.prototype.db = require(&#x27;mssql&#x27;);

core.prototype.merge = function(source, add, isNew)
{
    if (!add) add = {};
    if (void 0 === isNew || false === isNew)
    {
        for (var attrname in add)
        {
            if (add.hasOwnProperty(attrname))
            {
                source[attrname] = add[attrname];
            }
        }
        return source;
    }
    else
    {
        var newObj = {};
        Object.keys(source).forEach(function(name)
        {
            newObj[name] = source[name];
        });
        for (var attrname in add)
        {
            if (add.hasOwnProperty(attrname))
            {
                newObj[attrname] = add[attrname];
            }
        }
        return newObj;
    }
};

core.prototype.getRequest = function(transaction)
{
    var ms = require(&#x27;mssql&#x27;);
    if (void 0 === transaction)
    {
        //var connection = new ms.Connection(config);
        return new ms.Request();
    }
    else
    {
        return new ms.Request(transaction);
    }
};

core.prototype.tranBegin = function(callback)
{
    var tran = new this.db.Transaction();
    tran.begin(function(err)
    {
        callback(err, tran);
    });
};

core.prototype.getInsCommonColumns = function(userId)
{
    var date =  moment().format(&quot;YYYY/MM/DD HH:mm:ss&quot;);
    return {
        delete_flag: 0, create_by: userId, create_date: date, update_by: userId, update_date: date
    };
};

core.prototype.getUpdCommonColumns = function(userId)
{
    var date =  moment().format(&quot;YYYY/MM/DD HH:mm:ss&quot;);
    return {update_by: userId, update_date: date};
};

core.prototype.getQueryObject = function(col, table, where, groupby, orderby)
{
    return {
        col: col, 
        table: table, 
        where: where,
        groupby: groupby,
        orderby: orderby,
        request: this.getRequest()};
};

/**
 * シーケンス値を取得する.
 * 
 * @author niikawa
 * @method getNextSeq
 * @param {Function} callback
 */
core.prototype.getNextSeq = function(callback)
{
    console.log(&quot;SEQ NAME IS &quot; + this.seqName);
    var sql = &quot;SELECT NEXT VALUE FOR &quot; + this.seqName + &quot; AS id&quot;;
    return this.execute(sql, this.getRequest(), callback);
};

/**
 * 値をすべて取得する.
 * 
 * @author niikawa
 * @method getAllSync
 * @param {Function} callback
 */
core.prototype.getAll = function(condtion ,callback){

    var request = new this.db.Request();
    var columns;
    var option = &#x27; asc&#x27;;
    if (void 0 === condtion || &#x27;&#x27; === condtion || &#x27;function&#x27; === typeof(condtion))
    {
        columns = this.pk;
        callback = condtion;
    }
    else
    {
        columns = condtion.columns;
        if (void 0 !== condtion.option)
        {
            option = condtion.option;
        }
    }
    
    var sql = &#x27;select * from &#x27; + this.modelName + &#x27; where delete_flag = 0 &#x27;;
    if (void 0 !== columns)
    {
        sql += &#x27; order by &#x27; + columns + option;
    }
    this.execute(sql, request, callback);
};

/**
 * _idに合致した情報を取得する.
 * 
 * @author niikawa
 * @method getById
 * @param {Object} id
 * @param {Function} callback
 */
core.prototype.getById = function(id, callback)
{
    var request = this.getRequest();
    request.input(this.pk, this.db.Int, id);
    var sql = &#x27;select * from &#x27; + this.modelName + &#x27; WHERE &#x27; + this.pk + &#x27; = @&#x27; + this.pk + &#x27; AND delete_flag = 0&#x27;;
    this.execute(sql, request, callback);
};

core.prototype.select = function(queryObject, request, callback)
{
    var sql = &#x27;SELECT &#x27; + queryObject.col + &#x27; FROM &#x27; + queryObject.table;
    
    if (void 0 !== queryObject.where &amp;&amp; &#x27;&#x27; !== queryObject.where)
    {
        sql +=  &#x27; WHERE &#x27; + queryObject.where;
    }

    if (void 0 !== queryObject.groupby &amp;&amp; &#x27;&#x27; !== queryObject.groupby)
    {
        sql +=  &#x27; GROUP BY &#x27; + queryObject.groupby;
    }
    
    if (void 0 !== queryObject.orderby &amp;&amp; &#x27;&#x27; !== queryObject.orderby)
    {
        sql +=  &#x27; ORDER BY &#x27; + queryObject.orderby;
    }

    this.execute(sql, request, callback);
};

core.prototype.insert = function(table, data, request, callback)
{
    //callbackからはprototypeを参照できないので一度変数に入れておく
    var p = this.getPk();
    var exe = this.execute;
    var type = this.db.Int;
    
    if (void 0 === this.seqName)
    {
        var dataList = [];
        //SEQを設定
        console.log(data);

        var columns = Object.keys(data);
        var len = columns.length;
        for (var i = 0; i &lt; len; i ++)
        {
            var item = &#x27;@&#x27; + columns[i];
            dataList.push(item);
        }

        var sql = &#x27;INSERT INTO &#x27; + table + &#x27; (&#x27; + columns.join(&#x27;,&#x27;) + &#x27;) VALUES ( &#x27; + dataList.join(&#x27;,&#x27;) + &#x27; )&#x27;;
        exe(sql, request, function(errList, resultList)
        {
            callback(errList);
        });
    }
    else
    {
        this.getNextSeq(function(err, seqInfo)
        {
            if (0 &lt; err.length)
            {
                callback(err);
            }
            else
            {
                var dataList = [];
                //SEQを設定
                data[p] = seqInfo[0].id;
                console.log(data);
    
                var columns = Object.keys(data);
                var len = columns.length;
                for (var i = 0; i &lt; len; i ++)
                {
                    var item = &#x27;@&#x27; + columns[i];
                    dataList.push(item);
                }
                request.input(p, type, seqInfo[0].id);
                
                var sql = &#x27;INSERT INTO &#x27; + table + &#x27; (&#x27; + columns.join(&#x27;,&#x27;) + &#x27;) VALUES ( &#x27; + dataList.join(&#x27;,&#x27;) + &#x27; )&#x27;;
                exe(sql, request, function(errList, resultList)
                {
                    callback(errList, seqInfo[0].id);
                });
            }
        });
    }
};

core.prototype.updateById = function(data, request, callback)
{
    var id = data[this.pk];
    if (void 0 === id) { console.log(&#x27;pk is undefined&#x27;); return;}
    request.input(this.pk, this.db.Int, id);
    delete data[this.pk];

    var dataList = [];
    var columns = Object.keys(data);
    var len = columns.length;
    for (var i = 0; i &lt; len; i ++)
    {
        var item = columns[i] + &#x27; =@&#x27; + columns[i];
        dataList.push(item);
    }
    
    var sql = &#x27;UPDATE &#x27; + this.modelName + &#x27; SET &#x27; + dataList.join(&#x27;,&#x27;) + &#x27; WHERE &#x27; + this.pk + &#x27; = @&#x27; + this.pk + &#x27; AND delete_flag = 0&#x27;;
    this.execute(sql, request, callback);
};

core.prototype.updateByForeignKey = function(data, foreignKey, request, callback)
{
    var id = data[foreignKey];
    if (void 0 === id) { console.log(&#x27;fk is undefined&#x27;); return;}
    request.input(foreignKey, this.db.Int, id);
    delete data[foreignKey];

    var dataList = [];
    var columns = Object.keys(data);
    var len = columns.length;
    for (var i = 0; i &lt; len; i ++)
    {
        var item = columns[i] + &#x27; =@&#x27; + columns[i];
        dataList.push(item);
    }
    
    var sql = &#x27;UPDATE &#x27; + this.modelName + &#x27; SET &#x27; + dataList.join(&#x27;,&#x27;) + &#x27; WHERE &#x27; + foreignKey + &#x27; = @&#x27; + foreignKey + &#x27; AND delete_flag = 0&#x27;;
    this.execute(sql, request, callback);
};

core.prototype.removeById = function(idValue, callback)
{
    var request = this.getRequest();
    request.input(this.pk, this.db.Int, idValue);
    var sql = &#x27;UPDATE &#x27; + this.modelName + &#x27; SET delete_flag = 1&#x27; + &#x27; WHERE &#x27; + this.pk + &#x27; = @&#x27; + this.pk;
    this.execute(sql, request, callback);
};

core.prototype.removeByIdAndTran = function(idValue, transaction, callback)
{
    var request = this.getRequest(transaction);
    request.input(this.pk, this.db.Int, idValue);
    var sql = &#x27;UPDATE &#x27; + this.modelName + &#x27; SET delete_flag = 1&#x27; + &#x27; WHERE &#x27; + this.pk + &#x27; = @&#x27; + this.pk;
    this.execute(sql, request, callback);
};

core.prototype.deleteById = function(idValue, callback)
{
    var request = this.getRequest();
    request.input(this.pk, this.db.Int, idValue);
    var sql = &#x27;DELETE FROM &#x27; + this.modelName + &#x27; WHERE &#x27; + this.pk + &#x27; = @&#x27; + this.pk;
    this.execute(sql, request, callback);
};

core.prototype.isSameItem = function(columns, value, type, callback)
{
    var request = this.getRequest();
    request.input(columns, type, value);
    var sql = &#x27;SELECT COUNT(1) AS count FROM &#x27; + this.modelName + &#x27; WHERE &#x27; + columns + &#x27; = @&#x27; + columns +&#x27; AND delete_flag=0&#x27;;
    this.execute(sql, request, callback);
};

core.prototype.isSameItemByMultipleCondition = function(conditions, callback)
{
    var sql = &#x27;SELECT COUNT(1) AS count FROM &#x27; + this.modelName + &#x27; WHERE &#x27;;
    var request = this.getRequest();
    var num = conditions.length;
    for(var index = 0; index &lt; num; index++)
    {
        request.input(conditions[index].columns, conditions[index].type, conditions[index].value);
        sql += conditions[index].columns + &#x27; &#x27; + conditions[index].symbol +&#x27; @&#x27; + conditions[index].columns + &#x27; AND &#x27;;
    }
    sql += &#x27;delete_flag = 0&#x27;;
    this.execute(sql, request, callback);
};

core.prototype.execute = function(sql, request, callback)
{
    var result = [];
    var errList = [];
    console.log(sql);
    //auery実行
    request.query(sql);
    
    // レコードセットを取得するたびに呼び出される
    request.on(&#x27;recordset&#x27;, function(columns)
    {
       //console.log(columns);
    });
    
    // 行を取得するたびに呼ばれる
    request.on(&#x27;row&#x27;, function(row)
    {
       result.push(row);
    });

   // エラーが発生するたびによばれる
    request.on(&#x27;error&#x27;, function(err)
    {
       errList.push(err);
    });

    // 常時最後によばれる
    request.on(&#x27;done&#x27;, function(returnValue)
    {
        callback(errList, result);
    });
};

core.prototype.insertLog = function(userId, controlType, appendString, replace, data, callback)
{
    var logData = logInfo.get(controlType);
    var detail = logData.detail;
    if ((void 0 !== appendString))
    {
        var repString = appendString;
        if (void 0 !== replace)
        {
            repString = appendString.replace(&quot;$1&quot;, replace);
        }
        detail += &quot;&lt;br&gt;&quot; + repString;
    }
    
    if (void 0 !== data)
    {
//        detail += &#x27;NCHAR(13) + NCHAR(10)&#x27; ;
        // Object.keys(data).forEach(function(key)
        // {
            
        // });
    }
    
    var sql = &quot;INSERT INTO T_LOG (delete_flag, create_by, create_date, update_by, update_date, user_id, show_flag, control_type, detail)&quot;;
    sql += &quot; VALUES (@delete_flag, @create_by, @create_date, @update_by, @update_date, @user_id, @show_flag, @control_type, @detail)&quot;;
    var request = this.getRequest();
    request.input(&#x27;delete_flag&#x27;, this.db.SmallInt, 0);
    request.input(&#x27;create_by&#x27;, this.db.Int, userId);
    request.input(&#x27;create_date&#x27;, this.db.NVarChar, moment().format(&#x27;YYYY/MM/DD hh:mm:ss&#x27;));
    request.input(&#x27;update_by&#x27;, this.db.Int, userId);
    request.input(&#x27;update_date&#x27;, this.db.NVarChar, moment().format(&#x27;YYYY/MM/DD hh:mm:ss&#x27;));
    request.input(&#x27;user_id&#x27;, this.db.Int, userId);
    request.input(&#x27;show_flag&#x27;, this.db.Int, logData.show_flag);
    request.input(&#x27;control_type&#x27;, this.db.Int, controlType);
    request.input(&#x27;detail&#x27;, this.db.NVarChar, detail);
    this.execute(sql, request, function(err, ret)
    {
        console.log(err);
    });
    if (void 0 !== callback) callback();
};

core.prototype.appendUserInfoString = function(string ,req)
{
    return string + &quot; userId = &quot;+ req.session.userId + &quot; : [&quot; + req.session.userName + &quot;]&quot;;
};

//モジュール化
module.exports = core;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
