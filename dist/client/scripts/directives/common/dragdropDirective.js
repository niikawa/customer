var dDSharedServices=angular.module("myApp");dDSharedServices.service("DDShared",function(){var a={},b=0,c={},d=0,e=!1;return a.setFrom=function(a){c=a},a.getFrom=function(){return c},a.getFromCopyByIndex=function(a){return angular.copy(c[a])},a.getCopyFrom=function(){return angular.copy(c)},a.setOrverIndex=function(a){b=a},a.getOrverIndex=function(){return b},a.getBeforePosition=function(){return d},a.setBeforePosition=function(a){d=a},a.isMoveDown=function(){return e},a.setMove=function(a){e=a>0?!0:!1},a.clear=function(){b=0,c={}},a});var myApp=angular.module("myApp");myApp.directive("dragItemDirective",["DDShared",function(a){return{restrict:"AE",transclude:!1,require:"^ngModel",scope:{dragindex:"="},link:function(b,c,d,e){c.attr("draggable",!0),c.attr("data-index",b.dragindex),c.on("dragstart",function(b){var d=b.target.dataset.index,f=c.html();b.originalEvent.dataTransfer.setData("item",f),b.originalEvent.dataTransfer.setData("itemIndex",d),a.setFrom(e.$modelValue),a.setBeforePosition(0)})}}}]),myApp.directive("dropDirective",["DDShared",function(a){return{restrict:"A",scope:{dropLineName:"@"},require:"^ngModel",link:function(b,c,d,e){var f=void 0===b.dropLineName||""===b.dropLineName?"line":b.dropLineName;c.on("dragenter",function(){c.addClass("ui-drop-target")}),c.on("dragover",function(b){if(b.preventDefault(),void 0!==b.target.dataset.index){a.setOrverIndex(b.target.dataset.index);var c=Math.max.apply(null,[document.body.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.documentElement.clientHeight]),d=window.innerHeight||document.body.clientHeight||0;if(c>d){var e=b.target.getBoundingClientRect().top+$(b.target).position().top+50,f=0;if(0!=a.getBeforePosition()&&a.getBeforePosition()!=e){var g=$(b.target).height()+15;f=a.getBeforePosition()>e?-g:g,a.setMove(f),a.setBeforePosition(e-f),$(window).scrollTop($(window).scrollTop()+f)}else a.setBeforePosition(e)}}b.originalEvent.dataTransfer.dropEffect="move"}),c.on("dragleave",function(){c.removeClass("ui-drop-target")}),c.on("drop",function(c){c.stopPropagation(),a.setBeforePosition(0);var g=c.originalEvent.dataTransfer.getData("itemIndex"),h={},i=0===e.$modelValue.length?0:a.getOrverIndex();if(g===i)return!1;angular.isArray(a.getFrom())?(h=a.getFromCopyByIndex(g),a.getFrom().splice(g,1)):h=a.getCopyFrom(),void 0!==h&&e.$modelValue.splice(i,0,h);for(var j=e.$modelValue.length,k=0;j>k;k++)e.$modelValue[k][f]=k+1;var l={to:{},from:{},remove:{},isSameContainer:!1,areaKey:d.dropAreaKey,insertLine:i};l.to=e.$modelValue,l.from=a.getFrom(),l.remove=h,l.isSameContainer=l.to==l.from,b.$emit("dropItemComplete",l),console.log(l),b.$$phase||b.$apply()})}}}]),myApp.directive("dropJoinDirective",["DDShared",function(a){return{restrict:"A",scope:{dropJoinIndex:"="},require:"^ngModel",link:function(b,c,d,e){c.on("dragenter",function(){c.addClass("ui-drop-target")}),c.on("dragover",function(b){b.preventDefault(),void 0!==b.target.dataset.index&&a.setOrverIndex(b.target.dataset.index),b.originalEvent.dataTransfer.dropEffect="move"}),c.on("dragleave",function(){c.removeClass("ui-drop-target")}),c.on("drop",function(c){if(c.stopPropagation(),e.$modelValue==a.getFrom())return!1;var d=c.originalEvent.dataTransfer.getData("itemIndex"),f=a.getFromCopyByIndex(d);if(void 0===f)return!1;var g=!1;if(console.log(e.$modelValue),angular.isArray(e.$modelValue)){if(e.$modelValue[0].hasOwnProperty("table")&&e.$modelValue[0].hasOwnProperty("column")&&e.$modelValue[0].table.physicalname==f[0].table.physicalname&&e.$modelValue[0].column.physicalname==f[0].column.physicalname)return!1;g=!0}if(angular.isArray(a.getFrom())?a.getFrom().splice(d,1):f=a.getCopyFrom(),e.$modelValue==a.getFrom())return console.log(d),e.$modelValue.splice(d,d+1,f,e.$modelValue[d+1]),!1;if(g)e.$modelValue.push(angular.isArray(f)?f[0]:f);else{var h=[];h.push(e.$modelValue),h.push(f)}e.$modelValue.isJoin=e.$modelValue.length>1?!0:!1,console.log(e.$modelValue),b.$$phase||b.$apply(),console.log("drop join complete")})}}}]);