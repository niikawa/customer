var queryListCtrl=angular.module("queryListCtrl",["QueryServices"]);queryListCtrl.controller("QueryListCtrl",["$scope","Shared","Query","Segment","Modal","Location","Utility",function(a,b,c,d,e,f,g){function h(){a.queryList=[],b.setRoot("query list")}a.initialize=function(){a._construct(),h(),c.resource.getList().$promise.then(function(b){a.queryList=b.data,a.isQueryShow=a.queryList.length>0})},a.showSegment=function(b){if(void 0!==a.queryList[b].id){var c=a.queryList[b],g={qId:c.id,count:c.useNum};d.resource.useSegment(g).$promise.then(function(c){a.modalParam={title:a.queryList[b].query_name+"を利用しているセグメント",list:c.data,hrefBase:"#/segment/control",dynamicParamKey:"id",close:function(b){a.modalInstance.close(),f.segmentControl(b)}},a.modalInstance=e.open(a,"partials/modal/list.html")})}},a.deleteItem=function(b){if(void 0!==a.queryList[b]){var d=a.queryList[b].query_name;c.resource.remove({id:a.queryList[b].id}).$promise.then(function(){g.info(d+"<br>を削除しました。"),a.queryList.splice(b,1)})}}}]);var queryCtrl=angular.module("queryCtrl",["QueryServices"]);queryCtrl.controller("QueryCtrl",["$scope","$routeParams","Shared","Query","Location","Utility",function(a,b,c,d,e,f){function g(b){c.destloyByName("queryName"),c.destloyByName("updateQueryDocumentId"),a.tableList=[],a.tableListRef=[],a.columnNum=0,a.selectColumns=[],b||(a.selectColumns=c.get("queryColumns")||[]),a.showSelectedColumnsBox=a.selectColumns.length>0,a.conditions=[],a.isShowEditMessage=!1,a.returnUrl=d.getReturnURL(),c.setRoot("query")}function h(b){angular.forEach(b.tables,function(b,c){angular.forEach(b,function(b){angular.forEach(a.tableList[c].column,function(d){return b.column===d.physicalname?(a.selectColumns.push({table:{logicalname:a.tableList[c].logicalname,physicalname:a.tableList[c].physicalname},column:d,selectedCondition:{name:"",value:b.conditionType,symbol:""},condition:b.values}),!1):void 0})})}),a.showSelectedColumnsBox=a.selectColumns.length>0,c.set("queryColumns",a.selectColumns)}function i(){a.docIdUrl="";var b=c.get("updateQueryDocumentId");void 0!==b&&(a.docIdUrl="/control/"+b,a.isShowEditMessage=!0,a.queryName=c.get("updateQueryName"))}function j(){a.$on("dropItemComplete",function(b){b.stopPropagation(),angular.forEach(a.showConditions,function(a){console.log(a.length),1===a.length&&(a.isJoin=!1)})})}var k="";a.initialize=function(){var e=b.hasOwnProperty("id");a._construct(),g(e),e?d.resource.getControlInit({id:b.id}).$promise.then(function(e){a.queryName=e.data.query_name,a.tableList=e.table,a.tableListRef=d.getRefTabels(e.table),0===a.selectColumns.length&&h(e.data),a.isShowEditMessage=!0,c.set("updateQueryDocumentId",b.id),c.set("updateQueryName",e.data.query_name)}):d.resource.get().$promise.then(function(b){a.tableList=b.table,a.tableListRef=d.getRefTabels(b.table)})},a.showColumns=function(b){k=b,a.columnList=a.tableList[b].column,a.columnNum=a.columnList.length},a.setColumn=function(b){var d=a.tableList[k],e=!1;angular.forEach(a.selectColumns,function(a){a.table.physicalname===k&&a.column.physicalname===d.column[b].physicalname&&(e=!0)}),e||a.selectColumns.push({table:{logicalname:d.logicalname,physicalname:d.physicalname},column:d.column[b]}),a.showSelectedColumnsBox=!0,c.set("queryColumns",a.selectColumns)},a.removeColumn=function(b){a.selectColumns.splice(b,1),a.showSelectedColumnsBox=a.selectColumns.length>0,c.set("queryColumns",a.selectColumns)},a.nextValidation=function(){c.setRoot("query set"),a.selectColumns=c.get("queryColumns"),void 0===a.selectColumns&&e.query(),angular.forEach(a.selectColumns,function(){}),i()},a.removeItem=function(b){a.selectColumns.splice(b,1),0===a.selectColumns.length&&e.query()},a.next=function(){var b=!1;angular.forEach(a.selectColumns,function(a){return a.error?!1:void(b=!0)}),b&&e.querySave()},a.saveInitialize=function(){c.setRoot("query save"),j(),i(),a.query={query_name:c.get("updateQueryName")},a.conditions=[];var b=c.get("queryColumns");void 0===b&&e.query(),a.selectColumns=[],d.createCondtionString(b),a.showConditions=[],angular.forEach(b,function(b){var c=[];c.push(b),c.isJoin=!1,a.showConditions.push(c)})},a.isJoin=function(a){return a.isJoin},a.release=function(b,c){var d=[];d.push(a.showConditions[b][c]),console.log("削除前："+a.showConditions.length),a.showConditions[b].splice(c,1),console.log("削除後："+a.showConditions.length),console.log(a.showConditions),1===a.showConditions[b].length&&(a.showConditions[b].isJoin=!1),a.showConditions.push(b,0,d),console.log("ぷっしゅ後："+a.showConditions.length),console.log(a.showConditions)},a.save=function(){var b=c.get("queryColumns"),g=d.getTables(b),h={query_document_id:c.get("updateQueryDocumentId"),query_name:a.query.query_name,conditionList:a.showConditions,tables:g};d.resource.create(h).$promise.then(function(){c.destloyByName("queryColumns"),c.destloyByName("updateQueryName"),c.destloyByName("updateQueryDocumentId"),f.info("クエリを保存しました"),e.query()})},a.execute=function(){var b=c.get("queryColumns"),e=d.getTables(b),g={tables:e,conditionList:a.showConditions};d.resource.executeQuery(g).$promise.then(function(a){f.info("該当データは"+a.result+"件あります")})}}]);