var scenarioControlCtrl=angular.module("scenarioControlCtrl",["ScenarioServices","SegmentServices"]);scenarioControlCtrl.controller("ScenarioControlCtrl",["$scope","$routeParams","Modal","Shared","Utility","Location","Scenario",function(a,b,c,d,e,f,g){function h(){a.isBaseCollapse=!1,a.isOriginCollapse=!1,a.isShowExtraction=!1,a.pageTitle=o.title+o.addTitle,a.scenario={},a.scenario.approach,a.scenario.status,a.type=b.scenario,a.template=o.template,a.inputTag="",a.tagList=[],a.selectTagList=[],a.isTagCollapse=!1,d.setRoot(a.type+" scenario"),1===o.type?a.specificInfo={repeat_flag:null,expiration_start_date:e.today("YYYY-MM-DD"),expiration_end_date:"",interval:0,intervalCondition:"",daysCondition:g.daysCondition(),weekCondition:{mon:!1,tue:!1,wed:!1,thu:!1,fri:!1,sat:!1,sun:!1}}:2===o.type&&(a.conditions=[],a.specificInfo={},a.decisionList=[])}function i(){a.validators={segment:{isSelect:function(){var b=a.segmentList||{},c=!1;return angular.forEach(b,function(a){a.isPush&&(c=!0)}),c}},ifLayout:{isSelect:function(){var b=a.ifList||{},c=!1;return angular.forEach(b,function(a){a.isPush&&(c=!0)}),c}},expiration_start_date:{isDateValid:function(a,b){var c=a||b;return e.isDateValid(c)}},expiration_end_date:{isDateValid:function(a,b){var c=a||b;return e.isDateValid(c)},isAfter:function(b,c){var d=b||c;return e.isAfter(d,a.specificInfo.expiration_start_date)}},interval:{isSelect:function(a,b){var c=a||b;return 0!==c}},weekCondition:{isSelect:function(){var b=a.specificInfo.weekCondition||{},c=!1;return angular.forEach(b,function(a){a&&(c=!0)}),c}},daysCondition:{isSelect:function(){var b=a.specificInfo.daysCondition||{},c=!1;return angular.forEach(b,function(a){a.check&&(c=!0)}),c}}},a.asyncValidators={scenario_name:{same:function(a,b){var c=a||b;return void 0===c||0===c.length?!0:g.validators.isSameName({id:p,scenario_name:c})}},output_name:{same:function(a,b){var c=a||b;return void 0===c||0===c.length?!0:g.validators.isSameName({id:p,output_name:c})}}}}function j(){var c={type:b.scenario},d=void 0!==p;d&&(c.id=p),g.resource.initializeData(c).$promise.then(function(b){a.segmentList=b.segment,a.ifList=b.ifLayout,a.scenario=b.target,a.tagList=b.tagList,a.selectTagList=b.settinTags,1===o.type?d&&k(b):2===o.type&&(a.actionList=b.specific,d&&(a.activeId=b.specificInfo.doc.actionId,l(b)))})}function k(b){a.specificInfo.repeat_flag=b.specificInfo.specific.repeat_flag,a.specificInfo.expiration_start_date=e.formatString(b.specificInfo.specific.expiration_start_date),null!==b.specificInfo.specific.expiration_end_date&&(a.specificInfo.expiration_end_date=e.formatString(b.specificInfo.specific.expiration_end_date)),null!==b.specificInfo.doc&&(a.specificInfo.interval=b.specificInfo.doc.interval,2===a.specificInfo.interval?a.specificInfo.weekCondition=b.specificInfo.doc.weekCondition:3===a.specificInfo.interval&&(a.specificInfo.daysCondition=b.specificInfo.doc.daysCondition))}function l(b){a.specificInfo=b.specificInfo.specific,q=b.specificInfo.doc.actionId,a.isShowExtraction=!0;for(var c=b.specific.length,d=0;c>d;d++)if(q===b.specific[d].id){a.columnList=b.specific[d].column;break}angular.forEach(b.specificInfo.doc.conditionList,function(b){var c=[];angular.forEach(b,function(b){angular.forEach(a.columnList,function(a){b.physicalname==a.physicalname&&(a.condition=b.condition,a.selectedCondition=b.selectedCondition,c.push(a))})}),r.push(c);var d=g.createCondtionString(c);a.decisionList.push(d)})}function m(){a.$watch("scenario.scenario_name",function(){a.scenarioForm.scenario_name.$validate()}),a.$watch("scenario.output_name",function(){a.scenarioForm.output_name.$validate()}),a.$watch("segmentList",function(){a.scenarioForm.segment.$validate()},!0),a.$watch("ifList",function(){a.scenarioForm.ifLayout.$validate()},!0),1===o.type&&(null!==a.specificInfo.repeat_flag&&a.$watch("specificInfo.expiration_start_date",function(){a.scenarioForm.expiration_start_date.$validate()}),1===a.specificInfo.repeat_flag&&(a.$watch("specificInfo.expiration_end_date",function(){a.scenarioForm.expiration_end_date.$validate()}),a.$watch("specificInfo.interval",function(){a.scenarioForm.interval.$validate()})))}function n(){}var o=g.getPageProp(b.scenario,b.id),p=b.id,q=0,r=[];a.initialize=function(){a._construct(),h(),j(),i(),m(),n()},a.showAction=function(b,c){a.conditions=[],a.decisionList=[],q==b?a.isShowExtraction=!a.isShowExtraction:(a.isShowExtraction=!0,a.columnList=c,q=b)},a.addTag=function(){if(!(0>=a.inputTag.length)){var b=!0;angular.forEach(a.selectTagList,function(c){return a.inputTag===c.tag_name?(b=!1,!1):void 0}),b&&(a.selectTagList.push({tag_name:a.inputTag}),a.inputTag="")}},a.removeTag=function(b){a.selectTagList.splice(b,1)},a.moveCondition=function(b){var c={};angular.copy(b,c),a.conditions.push(c)},a.removeItem=function(b){a.conditions.splice(b,1)},a.decision=function(){var b=!0;if(angular.forEach(a.conditions,function(a){return a.error||""===a.condition.value1||void 0===a.condition.value1?(b=!1,!1):void 0}),b){r.push(a.conditions);var c=g.createCondtionString(a.conditions);a.decisionList.push(c),a.conditions=[]}},a.removeDecisionList=function(b){r.splice(b,1),a.decisionList.splice(b,1)},a.clear=function(){h(),j()},a.save=function(){var b,c;if(1===o.type)c={repeat_flag:a.specificInfo.repeat_flag,expiration_start_date:a.specificInfo.expiration_start_date,expiration_end_date:a.specificInfo.expiration_end_date},1==a.specificInfo.repeat_flag&&(b={interval:a.specificInfo.interval},2===a.specificInfo.interval?b.weekCondition=a.specificInfo.weekCondition:3===a.specificInfo.interval&&(b.daysCondition=a.specificInfo.daysCondition));else{if(2!==o.type)return!1;if(0===r.length)return!1;b={actionId:q,conditionList:g.getConditionDoc(r)},c=a.specificInfo}a.scenario.scenario_type=o.type,g.setActivePushItem(a.segmentList,"segment_id",a.scenario,"segment_id"),g.setActivePushItem(a.ifList,"id",a.scenario,"if_layout_id");var d={scenario:a.scenario,specificInfo:c,doc:b,tags:a.selectTagList};g.resource.save(d).$promise.then(function(){e.info("シナリオを保存しました。"),1===o.type?f.schedule():2===o.type&&f.trigger()})},a.weekConditionValidation=function(){a.scenarioForm.weekCondition.$validate()},a.daysConditionValidation=function(){a.scenarioForm.daysCondition.$validate()}}]);